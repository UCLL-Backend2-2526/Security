# Automatisch gegenereerde secret key

## Wat gaan we doen?

Verschillende testen falen nu met de error:

```
2025-11-28T13:40:52.719+01:00  WARN 17788 --- [Spring-Security] [           main] ConfigServletWebServerApplicationContext : Exception encountered during context initialization - cancelling refresh attempt: org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'sessionController' defined in file [C:\ucll\be2\UCLL-Backend2-2526\Security\18-FixTestsAgain\target\classes\be\ucll\backend2\controller\SessionController.class]: Unsatisfied dependency expressed through constructor parameter 0: Error creating bean with name 'sessionService' defined in file [C:\ucll\be2\UCLL-Backend2-2526\Security\18-FixTestsAgain\target\classes\be\ucll\backend2\service\SessionService.class]: Unsatisfied dependency expressed through constructor parameter 1: Error creating bean with name 'jwtService' defined in file [C:\ucll\be2\UCLL-Backend2-2526\Security\18-FixTestsAgain\target\classes\be\ucll\backend2\service\JwtService.class]: Unsatisfied dependency expressed through constructor parameter 0: Error creating bean with name 'jwtEncoder' defined in class path resource [be/ucll/backend2/config/SecurityConfig.class]: Unsatisfied dependency expressed through method 'jwtEncoder' parameter 0: Error creating bean with name 'secretKey' defined in class path resource [be/ucll/backend2/config/SecurityConfig.class]: Failed to instantiate [javax.crypto.SecretKey]: Factory method 'secretKey' threw exception with message: Cannot invoke "String.getBytes(java.nio.charset.Charset)" because "src" is null
```

Dit is het gevolg van het feit dat er standaard geen secret key is ingesteld. In deze stap gaan we de secret key genereren als er geen ingesteld is.

## Stappen

Om dit probleem op te lossen zullen we de `secretKey` *bean* in
[`SecurityConfig`](./src/main/java/be/ucll/backend2/config/SecurityConfig.java)
aanpassen zodat er één wordt aangemaakt als ze niet gedefinieerd is:

```java
@Bean
public SecretKey secretKey(JwtProperties jwtProperties) {
    if (jwtProperties.secretKey() == null) {
        logger.warn("No secret key configured, using autogenerated key");
        byte[] key = new byte[32];
        new SecureRandom().nextBytes(key);
        return new SecretKeySpec(key, "HmacSHA256");
    } else {
        final var secretBytes = Base64.getUrlDecoder().decode(jwtProperties.secretKey());
        return new SecretKeySpec(secretBytes, "HmacSHA256");
    }
}
```

Om te waarschuwen in het geval dat er geen secret key gedefinieerd is loggen we een bericht:

```java
logger.warn("No secret key configured, using autogenerated key");
```

Deze logger wordt als volgt gedefinieerd:

```java
private static final Logger logger = LoggerFactory.getLogger(SecurityConfig.class);
```

## Wat zien we nu?

Nu zullen de testen weer slagen omdat de secret key willekeurig gegenereerd wordt als deze ontbreekt.

## Conclusies

- Met een eigen logger kunnen we logberichten toevoegen

## Volgende stappen

In de volgende (en laatste) stap voegen we tenslotte OpenAPI documentatie en SwaggerUI toe.
